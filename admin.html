<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ìŠ¤íŠ¸ë§ í¬í† ë¶ ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page { page-break-after: always; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 1. ë¡œê·¸ì¸ ëª¨ë‹¬ (ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ ì‚­ì œë¨, ì•ˆë‚´ ë¬¸êµ¬ ì‚­ì œë¨) -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="lock" class="w-8 h-8 text-yellow-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <p class="text-gray-500 mb-6 text-sm">ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-yellow-400 outline-none" required>
                <button type="submit" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-3 rounded-lg transition shadow-sm">
                    ë¡œê·¸ì¸
                </button>
            </form>
        </div>
    </div>

    <!-- 2. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (UI ê°œì„ ë¨) -->
    <div id="changePwModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm relative">
            <button onclick="closeChangePwModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x"></i>
            </button>
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="key" class="w-5 h-5 text-yellow-500"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="currentPw" class="w-full border border-gray-300 p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-gray-50" placeholder="í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="newPw" class="w-full border border-gray-300 p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="confirmPw" class="w-full border border-gray-300 p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400" placeholder="í•œ ë²ˆ ë” ì…ë ¥í•´ì£¼ì„¸ìš”">
                    <p id="pwMatchMsg" class="text-xs mt-1 h-4"></p>
                </div>
            </div>

            <button onclick="handleChangePassword()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg transition mt-6 shadow-md">
                ë³€ê²½ ì™„ë£Œ
            </button>
        </div>
    </div>

    <!-- 3. ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div id="dashboard" class="min-h-screen flex flex-col hidden">
        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="bg-white shadow-sm sticky top-0 z-10 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-yellow-400 p-2 rounded-lg shadow-md">
                        <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 leading-none">í¬ìŠ¤íŠ¸ë§ í†µí•© ê´€ì œì‹¤</h1>
                        <p class="text-xs text-gray-500 mt-1">Authorized Access Only</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadExcel()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition shadow-sm font-bold text-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> ì—‘ì…€ ì†¡ì¥
                    </button>
                    <button onclick="printSelectedOrders()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition shadow-sm font-bold text-sm">
                        <i data-lucide="printer" class="w-4 h-4"></i> ì£¼ë¬¸ì„œ
                    </button>
                    
                    <div class="h-8 w-px bg-gray-300 mx-2"></div>

                    <button onclick="loadOrders()" class="bg-white border border-gray-300 hover:bg-gray-50 px-3 py-2 rounded-lg transition text-gray-600 shadow-sm" title="ìƒˆë¡œê³ ì¹¨">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openChangePwModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-2 rounded-lg transition shadow-sm text-sm font-medium flex items-center gap-1">
                        <i data-lucide="key" class="w-4 h-4"></i> ë¹„ë²ˆë³€ê²½
                    </button>
                    <button onclick="logout()" class="bg-gray-800 hover:bg-gray-900 text-white px-3 py-2 rounded-lg transition shadow-sm text-sm font-medium">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 no-print space-y-8">
            
            <!-- 1. í•µì‹¬ ì§€í‘œ (KPI) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- ì´ ì£¼ë¬¸ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Orders</p>
                            <h3 class="text-3xl font-black mt-2 text-gray-800" id="totalOrders">0ê±´</h3>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-xl text-blue-600"><i data-lucide="shopping-bag" class="w-6 h-6"></i></div>
                    </div>
                </div>
                <!-- ì´ ë§¤ì¶œ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Revenue</p>
                            <h3 class="text-3xl font-black mt-2 text-red-500" id="totalRevenue">0ì›</h3>
                        </div>
                        <div class="p-3 bg-red-50 rounded-xl text-red-600"><i data-lucide="coins" class="w-6 h-6"></i></div>
                    </div>
                </div>
                <!-- ì œì‘ ëŒ€ê¸° -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Processing</p>
                            <h3 class="text-3xl font-black mt-2 text-yellow-500" id="pendingOrders">0ê±´</h3>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-xl text-yellow-600"><i data-lucide="loader" class="w-6 h-6"></i></div>
                    </div>
                </div>
                <!-- ë°°ì†¡ ì¤‘ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Shipping</p>
                            <h3 class="text-3xl font-black mt-2 text-green-500" id="shippingOrders">0ê±´</h3>
                        </div>
                        <div class="p-3 bg-green-50 rounded-xl text-green-600"><i data-lucide="truck" class="w-6 h-6"></i></div>
                    </div>
                </div>
            </div>

            <!-- 2. ë‚ ì§œ ê²€ìƒ‰ -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="bg-gray-100 p-2 rounded-lg"><i data-lucide="calendar" class="w-4 h-4 text-gray-600"></i></div>
                    <span class="font-bold text-gray-700 text-lg">ê¸°ê°„ ì¡°íšŒ</span>
                </div>
                <div class="h-6 w-px bg-gray-300 mx-2"></div>
                <input type="date" id="startDate" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-400 outline-none shadow-sm text-gray-600">
                <span class="text-gray-400 font-bold">~</span>
                <input type="date" id="endDate" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-400 outline-none shadow-sm text-gray-600">
                <button onclick="searchOrders()" class="bg-gray-800 hover:bg-gray-900 text-white px-5 py-2 rounded-lg font-bold transition shadow-md">
                    ì¡°íšŒí•˜ê¸°
                </button>
                <button onclick="resetSearch()" class="text-gray-500 hover:text-gray-700 underline px-2">
                    ì „ì²´ë³´ê¸°
                </button>
            </div>

            <!-- 3. ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ -->
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4 text-gray-400"></i> ì£¼ë¬¸ ìƒì„¸ ë‚´ì—­
                    </h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wide border-b border-gray-100">
                                <th class="px-6 py-3 w-10 text-center"><input type="checkbox" id="selectAll" onclick="toggleAll(this)" class="rounded w-4 h-4 cursor-pointer text-yellow-500 focus:ring-yellow-500"></th>
                                <th class="px-6 py-3 font-bold">ì ‘ìˆ˜ì¼ / ì£¼ë¬¸ë²ˆí˜¸</th>
                                <th class="px-6 py-3 font-bold">ê³ ê° ì •ë³´</th>
                                <th class="px-6 py-3 font-bold">ìƒí’ˆ ì •ë³´ (ìˆ˜ëŸ‰)</th>
                                <th class="px-6 py-3 font-bold text-right">ê²°ì œ ê¸ˆì•¡</th>
                                <th class="px-6 py-3 font-bold text-center">ì§„í–‰ ìƒíƒœ</th>
                                <th class="px-6 py-3 font-bold text-right">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="order-list" class="divide-y divide-gray-100 text-sm">
                            <tr><td colspan="7" class="p-10 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                        </tbody>
                        <!-- í•©ê³„ í‘¸í„° -->
                        <tfoot class="bg-yellow-50 border-t-2 border-yellow-100">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-right font-bold text-gray-700 text-sm">
                                    <span class="text-gray-500 font-normal mr-2">ì„ íƒ ê¸°ê°„ í•©ê³„:</span>
                                    ì´ <span id="footer-count" class="text-black text-lg">0</span> ê±´
                                </td>
                                <td class="px-6 py-4 text-right font-black text-red-600 text-xl" id="footer-total">0ì›</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- ì¸ì‡„ìš© ì˜ì—­ -->
    <div id="print-area" class="hidden"></div>

    <script>
        lucide.createIcons();
        const API_BASE = "http://127.0.0.1:8000";
        let allOrders = [];
        let currentOrders = [];
        let adminToken = localStorage.getItem('adminToken'); // ì €ì¥ëœ ë¹„ë²ˆ í™•ì¸

        // ë¡œê·¸ì¸ ì²´í¬
        if (adminToken) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadOrders();
            setInterval(loadOrders, 10000); // 10ì´ˆ ê°±ì‹ 
        }

        async function handleLogin(e) {
            e.preventDefault();
            // [ìˆ˜ì •] ê³µë°± ì œê±° ì¶”ê°€
            const password = document.getElementById('adminPassword').value.trim();
            try {
                const formData = new FormData();
                formData.append('password', password);
                const res = await fetch(`${API_BASE}/api/admin/login`, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('adminToken', password);
                    adminToken = password;
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadOrders();
                    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¶Œì¥ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                    if (data.message !== "ë¡œê·¸ì¸ ì„±ê³µ!") alert(data.message);
                } else {
                    // [ìˆ˜ì •] ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ê°•í™”
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!\n\në§Œì•½ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸(153153)ê°€ ì•ˆ ëœë‹¤ë©´,\nì„œë²„ í´ë”(í¬í† ë¶í”„ë¡œì íŠ¸) ì•ˆì— ìˆëŠ” 'admin_secrets.json' íŒŒì¼ì„ ì‚­ì œí•˜ê³ \nì„œë²„(main.py)ë¥¼ ê»ë‹¤ ë‹¤ì‹œ ì¼œì£¼ì„¸ìš”.");
                }
            } catch (err) { alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨! main.pyê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openChangePwModal() {
            document.getElementById('currentPw').value = '';
            document.getElementById('newPw').value = '';
            document.getElementById('confirmPw').value = '';
            document.getElementById('pwMatchMsg').innerText = '';
            document.getElementById('changePwModal').classList.remove('hidden');
        }
        function closeChangePwModal() {
            document.getElementById('changePwModal').classList.add('hidden');
        }

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì‹¤ì‹œê°„ ì²´í¬
        document.getElementById('confirmPw').addEventListener('input', function() {
            const newPw = document.getElementById('newPw').value;
            const confirmPw = this.value;
            const msg = document.getElementById('pwMatchMsg');
            
            if (newPw && confirmPw) {
                if (newPw === confirmPw) {
                    msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.";
                    msg.className = "text-xs mt-1 h-4 text-green-600 font-bold";
                } else {
                    msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    msg.className = "text-xs mt-1 h-4 text-red-500 font-bold";
                }
            } else {
                msg.innerText = "";
            }
        });

        async function handleChangePassword() {
            const currentPw = document.getElementById('currentPw').value;
            const newPw = document.getElementById('newPw').value;
            const confirmPw = document.getElementById('confirmPw').value;
            
            if(!currentPw || !newPw) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(newPw !== confirmPw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

            const formData = new FormData();
            formData.append('current_password', currentPw);
            formData.append('new_password', newPw);

            try {
                const res = await fetch(`${API_BASE}/api/admin/change_password`, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ! ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    logout();
                } else {
                    alert(data.message || "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨");
                }
            } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        function logout() {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('adminToken');
                location.reload();
            }
        }

        const statusColors = {
            "ì ‘ìˆ˜ë¨": "bg-gray-100 text-gray-600 border border-gray-200",
            "ì œì‘ì¤‘": "bg-yellow-50 text-yellow-700 border border-yellow-200 animate-pulse",
            "ì œì‘ì™„ë£Œ": "bg-blue-50 text-blue-700 border border-blue-200",
            "ë°°ì†¡ì¤‘": "bg-purple-50 text-purple-700 border border-purple-200",
            "ë°°ì†¡ì™„ë£Œ": "bg-green-50 text-green-700 border border-green-200",
            "ì˜¤ë¥˜ë°œìƒ": "bg-red-50 text-red-700 border border-red-200"
        };

        async function loadOrders() {
            if (!adminToken) return;
            try {
                const res = await fetch(`${API_BASE}/api/admin/orders`);
                const orders = await res.json();
                allOrders = orders;
                
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                
                if (start || end) {
                    searchOrders(); 
                } else {
                    currentOrders = orders;
                    renderTable(orders);
                    updateGlobalStats(orders);
                }
            } catch (e) { console.error(e); }
        }

        async function changeStatus(id, status) {
            if(!confirm(`ì£¼ë¬¸ìƒíƒœë¥¼ [${status}]ë¡œ ë³€ê²½í• ê¹Œìš”?`)) return;
            const form = new FormData();
            form.append('order_id', id);
            form.append('status', status);
            await fetch(`${API_BASE}/api/admin/status`, { method: 'POST', body: form });
            loadOrders();
        }

        function updateGlobalStats(orders) {
            document.getElementById('totalOrders').innerText = orders.length;
            const total = orders.reduce((sum, o) => sum + (o.info?.price || 0), 0);
            document.getElementById('totalRevenue').innerText = total.toLocaleString();
            document.getElementById('pendingOrders').innerText = orders.filter(o => ['ì ‘ìˆ˜ë¨', 'ì œì‘ì¤‘'].includes(o.status)).length;
            document.getElementById('shippingOrders').innerText = orders.filter(o => o.status === 'ë°°ì†¡ì¤‘').length;
        }

        function searchOrders() {
            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            
            if (!startVal && !endVal) {
                currentOrders = allOrders;
            } else {
                const startDate = startVal ? new Date(startVal) : new Date('2000-01-01');
                const endDate = endVal ? new Date(endVal) : new Date();
                endDate.setHours(23, 59, 59, 999);

                currentOrders = allOrders.filter(o => {
                    const orderDate = new Date(o.date.split(' ')[0]);
                    return orderDate >= startDate && orderDate <= endDate;
                });
            }
            renderTable(currentOrders);
        }

        function resetSearch() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            searchOrders();
        }

        function renderTable(orders) {
            const tbody = document.getElementById('order-list');
            const footerCount = document.getElementById('footer-count');
            const footerTotal = document.getElementById('footer-total');

            const totalCount = orders.length;
            const totalPrice = orders.reduce((sum, o) => sum + (o.info?.price || 0), 0);
            
            footerCount.innerText = `(${totalCount}ê±´)`;
            footerTotal.innerText = totalPrice.toLocaleString() + "ì›";

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(o => {
                const badgeColor = statusColors[o.status] || "bg-gray-100 text-gray-600 border-gray-200";
                const quantity = o.info?.quantity || 1;
                const coverUrl = o.files?.cover ? `${API_BASE}${o.files.cover}` : '#';
                const innerUrl = o.files?.inner ? `${API_BASE}${o.files.inner}` : '#';

                return `
                <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-b-0">
                    <td class="px-6 py-4 text-center"><input type="checkbox" name="orderCheck" value="${o.id}" class="rounded w-5 h-5 cursor-pointer text-yellow-500 focus:ring-yellow-500"></td>
                    <td class="px-6 py-4"><div class="font-bold text-gray-800 text-sm">${o.date.split(' ')[0]}</div><div class="text-xs text-gray-400 mt-1 font-mono">${o.id}</div></td>
                    <td class="px-6 py-4"><div class="font-bold text-sm">${o.user.name}</div><div class="text-xs text-gray-500 mt-0.5">${o.user.phone}</div><div class="text-xs text-gray-400 mt-1 truncate max-w-[150px]" title="${o.user.addr}">${o.user.addr}</div></td>
                    <td class="px-6 py-4"><div class="font-medium text-indigo-900 truncate max-w-[180px] text-sm" title="${o.info.title}">"${o.info.title}"</div><div class="text-xs text-gray-500 mt-1.5 flex items-center gap-2"><span class="bg-gray-100 px-2 py-0.5 rounded border border-gray-200">ì‚¬ì§„ ${o.info.photos}ì¥</span><span class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100 font-bold">${quantity}ê¶Œ</span></div></td>
                    <td class="px-6 py-4 text-right font-black text-gray-800 text-base">${(o.info.price || 0).toLocaleString()}ì›</td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ${badgeColor} shadow-sm inline-block min-w-[60px]">${o.status}</span></td>
                    <td class="px-6 py-4 text-right">
                        ${o.status === 'ì œì‘ì™„ë£Œ' || o.status === 'ë°°ì†¡ì¤‘' || o.status === 'ë°°ì†¡ì™„ë£Œ' ? `
                            <div class="flex flex-col gap-2 items-end">
                                <div class="flex gap-1">
                                    <a href="${innerUrl}" download target="_blank" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-bold hover:bg-gray-50 flex items-center gap-1 shadow-sm transition"><i data-lucide="file-text" class="w-3 h-3 text-blue-500"></i> ë‚´ì§€</a>
                                    <a href="${coverUrl}" download target="_blank" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-bold hover:bg-gray-50 flex items-center gap-1 shadow-sm transition"><i data-lucide="image" class="w-3 h-3 text-indigo-500"></i> í‘œì§€</a>
                                </div>
                                <div class="flex gap-1 mt-1">
                                    <button onclick="changeStatus('${o.id}', 'ë°°ì†¡ì¤‘')" class="px-2 py-1 bg-purple-50 text-purple-700 border border-purple-200 rounded text-xs hover:bg-purple-100 font-medium">ğŸšš ë°œì†¡</button>
                                    <button onclick="changeStatus('${o.id}', 'ë°°ì†¡ì™„ë£Œ')" class="px-2 py-1 bg-green-50 text-green-700 border border-green-200 rounded text-xs hover:bg-green-100 font-medium">âœ… ì™„ë£Œ</button>
                                </div>
                            </div>
                        ` : `<div class="text-center py-2"><span class="text-xs text-gray-400 flex items-center justify-end gap-1 animate-pulse"><i data-lucide="loader" class="w-3 h-3 animate-spin"></i> ì œì‘ ì¤‘...</span></div>`}
                    </td>
                </tr>
                `
            }).join('');
            lucide.createIcons();
        }

        function toggleAll(source) {
            const checkboxes = document.getElementsByName('orderCheck');
            for(let i=0; i<checkboxes.length; i++) checkboxes[i].checked = source.checked;
        }

        function getSelectedOrders() {
            const checkboxes = document.querySelectorAll('input[name="orderCheck"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            return currentOrders.filter(o => selectedIds.includes(o.id));
        }

        function downloadExcel() {
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length === 0) return alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            const data = selectedOrders.map(o => ({
                "ì£¼ë¬¸ë²ˆí˜¸": o.id, "ìˆ˜ë ¹ì¸": o.user.name, "ì „í™”ë²ˆí˜¸": o.user.phone, "ì£¼ì†Œ": o.user.addr,
                "ìƒí’ˆëª…": `[í¬í† ë¶] ${o.info.title}`, "ìˆ˜ëŸ‰": o.info.quantity || 1, "ë°°ì†¡ë©”ëª¨": "ë¶€ì¬ì‹œ ë¬¸ì•", "ì£¼ë¬¸ì¼ì": o.date
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì£¼ë¬¸ë°œì†¡ëª©ë¡");
            const today = new Date().toISOString().slice(0,10).replace(/-/g,"");
            XLSX.writeFile(wb, `í¬í† ë¶_ë°°ì†¡ëª©ë¡_${today}.xlsx`);
        }

        function printSelectedOrders() {
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length === 0) return alert("ì¸ì‡„í•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = "";
            
            selectedOrders.forEach(o => {
                const quantity = o.info.quantity || 1;
                const pageHtml = `
                    <div class="print-page bg-white p-10 max-w-[210mm] mx-auto mb-4 border border-gray-300 font-sans">
                        <div class="flex justify-between items-end border-b-2 border-gray-800 pb-4 mb-8">
                            <h1 class="text-4xl font-black text-gray-900">ì£¼ ë¬¸ í™• ì¸ ì„œ</h1>
                            <div class="text-right"><div class="text-sm text-gray-500">ì£¼ë¬¸ë²ˆí˜¸</div><div class="text-lg font-bold font-mono">${o.id}</div></div>
                        </div>
                        <div class="mb-10"><h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2"><span class="w-2 h-8 bg-blue-600 rounded"></span> ë°°ì†¡ì§€ ì •ë³´</h2><table class="w-full text-sm"><tr><th class="text-left py-3 px-4 bg-gray-100 font-bold w-32 border-b">ìˆ˜ë ¹ì¸</th><td class="py-3 px-4 border-b font-bold text-lg">${o.user.name}</td></tr><tr><th class="text-left py-3 px-4 bg-gray-100 font-bold border-b">ì—°ë½ì²˜</th><td class="py-3 px-4 border-b">${o.user.phone}</td></tr><tr><th class="text-left py-3 px-4 bg-gray-100 font-bold border-b">ì£¼ì†Œ</th><td class="py-3 px-4 border-b">${o.user.addr}</td></tr></table></div>
                        <div class="mb-10"><h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2"><span class="w-2 h-8 bg-yellow-400 rounded"></span> ì£¼ë¬¸ ìƒí’ˆ</h2><table class="w-full text-sm text-center border-t-2 border-gray-800"><thead class="bg-gray-50"><tr><th class="py-3 px-4 border-b font-bold text-left">ìƒí’ˆëª… / ì˜µì…˜</th><th class="py-3 px-4 border-b font-bold">ìˆ˜ëŸ‰</th></tr></thead><tbody><tr><td class="py-4 px-4 border-b text-left"><div class="font-bold text-lg text-gray-900">ì›ì—†ì´ ë‹´ëŠ” í¬í† ë¶</div><div class="text-gray-500 mt-1">ì œëª©: ${o.info.title}</div></td><td class="py-4 px-4 border-b font-bold text-2xl">${quantity}</td></tr></tbody></table></div>
                    </div><div style="page-break-after: always;"></div>
                `;
                printArea.insertAdjacentHTML('beforeend', pageHtml);
            });
            window.print();
        }

        loadOrders();
        setInterval(loadOrders, 5000);
    </script>
</body>
</html>